<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>–§—ñ–∫—Å–æ–≤–∞–Ω–∏–π –ø–æ–≤–æ—Ä–æ—Ç –º–∞—Ä–∫–µ—Ä–∞ –∑ –≤—Ö–æ–¥–æ–º</title>
  <script src="https://cdn.maptiler.com/maptiler-sdk-js/v3.6.1/maptiler-sdk.umd.min.js"></script>
  <link href="https://cdn.maptiler.com/maptiler-sdk-js/v3.6.1/maptiler-sdk.css" rel="stylesheet" />
  <style>
    body, html { margin: 0; padding: 0; height: 100%; font-family: Arial, sans-serif; }
    #map { position: absolute; top: 0; bottom: 0; width: 100%; height: 100%; }
    #controlContainer {
      position: absolute;
      top: 10px;
      left: 10px;
      z-index: 1000;
      user-select: none;
      font-family: Arial, sans-serif;
      display: flex;
      align-items: flex-start;
      gap: 12px;
    }

    /* –õ–µ–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞: –∫–Ω–æ–ø–∫–∞ + —Å–≤–µ—Ä—Ö—É, –∫–Ω–æ–ø–∫–∞ –∫–æ—Ä–∑–∏–Ω–∫–∏ —Å–Ω–∏–∑—É */
    #leftButtons {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 12px;
      justify-content: flex-start;
      height: 88px;
    }
    #mainButton {
      order: 1;
      font-size: 22px;
    }
    #clearAllBtn {
      order: 2;
      font-size: 18px;
      height: 36px;
      width: 40px;
    }

    /* –°–ø—Ä–∞–≤–∞ ‚Äî –∫–Ω–æ–ø–∫–∞ "–î–æ–¥–∞—Ç–∏ —Ü—ñ–ª—å" –∏–∑–Ω–∞—á–∞–ª—å–Ω–æ —Å–∫—Ä—ã—Ç–∞ */
    #buttonsWrapper {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    #addTargetBtn {
      white-space: nowrap;
      font-size: 16px;
      display: none; /* –ò–∑–Ω–∞—á–∞–ª—å–Ω–æ —Å–∫—Ä—ã—Ç–∞ */
      padding: 8px 14px;
    }

    /* –ê–∫—Ç–∏–≤–Ω–∞—è –∫–Ω–æ–ø–∫–∞ */
    #addTargetBtn.active-button {
      background-color: white;
      color: #222;
      border-color: #999;
    }

    /* –ò–∫–æ–Ω–∫–∏ */
    #iconButtons {
      display: none;
      gap: 6px;
    }
    #iconButtons button {
      padding: 0 8px;
      font-size: 14px;
    }
    #iconButtons button.active {
      background-color: #444;
      border-color: #222;
    }

    /* –°–∫—Ä—ã–≤–∞–µ–º –∫–∞—Ä—Ç—É –∏ –∫–Ω–æ–ø–∫–∏ –ø—Ä–∏ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω–æ–º –≤—Ö–æ–¥–µ */
    body.locked #map,
    body.locked #controlContainer {
      display: none !important;
    }

    /* –í—Ö–æ–¥ - –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ */
    #loginOverlay {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.9);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 20000;
    }
    #loginBox {
      background: #222;
      padding: 40px 40px 35px 40px;
      border-radius: 14px;
      color: white;
      width: 320px;
      box-shadow: 0 6px 18px rgba(0,0,0,0.85);
      text-align: center;
      font-size: 16px;
      letter-spacing: 0.02em;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 16px;
    }
    #loginBox h2 {
      margin: 0 0 24px 0;
      font-weight: 400;
      font-size: 24px;
      letter-spacing: 0.03em;
    }
    #loginBox input {
      width: 240px;
      padding: 14px 16px;
      border-radius: 10px;
      border: none;
      font-size: 16px;
      background-color: #333;
      color: white;
      box-shadow: inset 0 0 6px rgba(0,0,0,0.6);
      outline: none; /* –£–±–∏—Ä–∞–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π outline */
    }
    #loginBox input::placeholder {
      color: #999;
    }
    /* –£–±–∏—Ä–∞–µ–º –ª—é–±—ã–µ —Å–≤–µ—á–µ–Ω–∏—è –∏ —Ç–µ–Ω–∏ –ø—Ä–∏ —Ñ–æ–∫—É—Å–µ */
    #loginBox input:focus {
      background-color: #333;
      box-shadow: inset 0 0 6px rgba(0,0,0,0.6);
      outline: none;
    }
    #loginError {
      color: #ff5555;
      font-weight: 600;
      display: none;
      margin: 0;
    }
    #loginBox button {
      background-color: white;
      color: #222;
      font-size: 14px;
      font-weight: 600;
      padding: 12px 0;
      width: 120px;
      border-radius: 12px;
      border: none;
      cursor: pointer;
      box-shadow: 0 4px 10px rgba(0,0,0,0.4);
      transition: background-color 0.3s, box-shadow 0.3s;
      margin-top: 4px;
    }
    #loginBox button:hover {
      background-color: #eee;
      box-shadow: 0 6px 14px rgba(0,0,0,0.6);
    }

    /* –û—Å—Ç–∞–ª—å–Ω—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è –∫–Ω–æ–ø–æ–∫ */
    button:not(#loginBox button) {
      height: 40px;
      min-width: 40px;
      border-radius: 6px;
      border: 1px solid #444;
      background-color: #222;
      color: white;
      box-shadow: 0 1px 4px rgba(0,0,0,0.8);
      cursor: pointer;
      font-size: 16px;
      padding: 0 10px;
      user-select: none;
      transition: background-color 0.2s, color 0.2s;
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }
    button:not(#loginBox button):hover {
      background-color: white;
      color: #222;
      border-color: #999;
    }

    #modalOverlay {
      display: none;
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.5);
      z-index: 10000;
      justify-content: center;
      align-items: center;
    }
    #modal {
      background: #222;
      color: white;
      padding: 20px 30px;
      border-radius: 10px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.7);
      max-width: 320px;
      text-align: center;
    }
    #modal p {
      margin-bottom: 20px;
      font-size: 18px;
    }
    #modal button {
      margin: 0 10px;
      min-width: 80px;
      font-weight: bold;
    }
    #modal button.confirm {
      background-color: #111;
      border: 1px solid #333;
      color: white;
    }
    #modal button.cancel {
      background-color: white;
      border: 1px solid #ccc;
      color: #111;
    }

    #previewIcon {
      position: absolute;
      width: 45px;
      height: 45px;
      pointer-events: none;
      background-size: contain;
      background-repeat: no-repeat;
      transform-origin: center bottom;
      transform: translate(-50%, -100%) rotate(0deg);
      z-index: 99999;
      display: none;
      user-select: none;
    }

    .watermark {
      position: fixed;
      user-select: none;
      pointer-events: none;
      font-family: Arial, sans-serif;
      font-weight: bold;
      color: rgba(255, 255, 255, 0.18);
      text-shadow: 0 0 2px rgba(0, 0, 0, 0.6);
      opacity: 0.18;
      text-align: center;
      white-space: nowrap;
      z-index: 9999;
      transform: translate(-50%, -50%);
    }
    .watermark .line1 {
      font-size: 28px;
      line-height: 1;
    }
    .watermark .line2 {
      font-size: 16px;
      line-height: 1;
      margin-top: 2px;
    }
  </style>
</head>
<body class="locked">

<div id="loginOverlay">
  <div id="loginBox">
    <h2>–í—Ö—ñ–¥</h2>
    <div id="loginError">–ù–µ–≤—ñ—Ä–Ω–∏–π –ª–æ–≥—ñ–Ω –∞–±–æ –ø–∞—Ä–æ–ª—å</div>
    <input id="username" type="text" placeholder="–õ–æ–≥—ñ–Ω" autocomplete="username" />
    <input id="password" type="password" placeholder="–ü–∞—Ä–æ–ª—å" autocomplete="current-password" />
    <button id="loginBtn">–£–≤—ñ–π—Ç–∏</button>
  </div>
</div>

<div id="map"></div>

<div id="controlContainer">
  <div id="leftButtons">
    <button id="mainButton" title="–î–æ–¥–∞—Ç–∏ —Ü—ñ–ª—å">+</button>
    <button id="clearAllBtn" title="–í–∏–¥–∞–ª–∏—Ç–∏ –≤—Å—ñ –º–∞—Ä–∫–µ—Ä–∏">üóë</button>
  </div>

  <div id="buttonsWrapper">
    <button id="addTargetBtn" style="display:none;">–î–æ–¥–∞—Ç–∏ —Ü—ñ–ª—å</button>
    <div id="iconButtons">
      <button data-icon="drone">–ë–ü–õ–ê</button>
      <button data-icon="strike">–£–¥–∞—Ä–Ω–∏–π –ë–ü–õ–ê</button>
      <button data-icon="rocket">–†–∞–∫–µ—Ç–∞</button>
      <button data-icon="plane">–õ—ñ—Ç–∞–∫</button>
    </div>
  </div>
</div>

<div id="modalOverlay">
  <div id="modal">
    <p>–í–∏–¥–∞–ª–∏—Ç–∏ –º–∞—Ä–∫–µ—Ä?</p>
    <button class="confirm">–¢–∞–∫</button>
    <button class="cancel">–ù—ñ</button>
  </div>
</div>

<div id="previewIcon"></div>

<script>
  maptilersdk.config.apiKey = '0JS2tnRtcno7mfYAiQHF';

  const map = new maptilersdk.Map({
    container: 'map',
    style: 'https://api.maptiler.com/maps/14b55bf0-5cf0-4853-9f7e-69835410e5cf/style.json?key=0JS2tnRtcno7mfYAiQHF',
    center: [31.66132, 48.43453],
    zoom: 5.8,
    navigationControl: false,
    geolocateControl: false,
  });

  const loginOverlay = document.getElementById('loginOverlay');
  const loginBtn = document.getElementById('loginBtn');
  const usernameInput = document.getElementById('username');
  const passwordInput = document.getElementById('password');
  const loginError = document.getElementById('loginError');

  const addTargetBtn = document.getElementById('addTargetBtn');
  addTargetBtn.style.display = 'none'; // –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ–º —Å–∫—Ä—ã—Ç–∏–µ –∫–Ω–æ–ø–∫–∏

  const correctUsername = 'admin';
  const correctPassword = 'admin';

  loginBtn.addEventListener('click', () => {
    const username = usernameInput.value.trim();
    const password = passwordInput.value;

    if (username === correctUsername && password === correctPassword) {
      loginError.style.display = 'none';
      loginOverlay.style.display = 'none';
      document.body.classList.remove('locked');
    } else {
      loginError.style.display = 'block';
    }
  });

  passwordInput.addEventListener('keyup', (e) => {
    if (e.key === 'Enter') loginBtn.click();
  });

  let markers = [];
  const mainButton = document.getElementById('mainButton');
  const clearAllBtn = document.getElementById('clearAllBtn');
  const iconButtons = document.getElementById('iconButtons');
  const iconButtonsList = iconButtons.querySelectorAll('button');
  const previewIcon = document.getElementById('previewIcon');
  const modalOverlay = document.getElementById('modalOverlay');
  const modalConfirmBtn = modalOverlay.querySelector('button.confirm');
  const modalCancelBtn = modalOverlay.querySelector('button.cancel');

  let selectedIconKey = null;
  let markerToDelete = null;
  let previewRotation = 0;
  let isRotating = false;
  let fixedX = 0;
  let fixedY = 0;

  const iconImages = {
    drone: 'https://i.postimg.cc/XNmNQxbW/scout1.png',
    strike: 'https://i.postimg.cc/yxBjH0q8/shahed1.png',
    rocket: 'https://i.postimg.cc/tCz9S4gd/rocket.png',
    plane: 'https://i.postimg.cc/6pwyqP8c/plane.png'
  };

  mainButton.addEventListener('click', () => {
    const isHidden = window.getComputedStyle(addTargetBtn).display === 'none';
    if (isHidden) {
      addTargetBtn.style.display = 'inline-flex';
    } else {
      addTargetBtn.style.display = 'none';
      addTargetBtn.classList.remove('active-button');
      iconButtons.style.display = 'none';
      selectedIconKey = null;
      iconButtonsList.forEach(b => b.classList.remove('active'));
      previewIcon.style.display = 'none';
    }
  });

  clearAllBtn.addEventListener('click', () => {
    markers.forEach(m => m.remove());
    markers.length = 0;
  });

  addTargetBtn.addEventListener('click', () => {
    const isActive = addTargetBtn.classList.contains('active-button');
    addTargetBtn.classList.toggle('active-button', !isActive);
    iconButtons.style.display = isActive ? 'none' : 'flex';
    if (isActive) {
      selectedIconKey = null;
      iconButtonsList.forEach(b => b.classList.remove('active'));
      previewIcon.style.display = 'none';
    }
  });

  iconButtonsList.forEach(btn => {
    btn.addEventListener('click', () => {
      selectedIconKey = btn.dataset.icon;
      iconButtonsList.forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      previewRotation = 0;
      previewIcon.style.backgroundImage = `url(${iconImages[selectedIconKey]})`;
      previewIcon.style.display = 'block';
      previewIcon.style.transform = `translate(-50%, -100%) rotate(0deg)`;
    });
  });

  map.getCanvas().addEventListener('mousedown', e => {
    if (!selectedIconKey || e.button === 2) return;
    isRotating = true;
    if (map.dragPan && map.dragPan.disable) map.dragPan.disable();
    const rect = map.getCanvas().getBoundingClientRect();
    fixedX = e.clientX - rect.left;
    fixedY = e.clientY - rect.top;
    previewIcon.style.left = `${fixedX}px`;
    previewIcon.style.top = `${fixedY}px`;
  });

  map.getCanvas().addEventListener('mousemove', e => {
    if (!selectedIconKey) return;
    const rect = map.getCanvas().getBoundingClientRect();
    const x = e.clientX - rect.left;
    const y = e.clientY - rect.top;
    if (!isRotating) {
      previewIcon.style.left = `${x}px`;
      previewIcon.style.top = `${y}px`;
      return;
    }
    previewRotation += e.movementX * 0.5;
    previewIcon.style.transform = `translate(-50%, -100%) rotate(${previewRotation}deg)`;
    previewIcon.style.left = `${fixedX}px`;
    previewIcon.style.top = `${fixedY}px`;
  });

  map.getCanvas().addEventListener('mouseup', e => {
    if (!isRotating || !selectedIconKey) return;
    isRotating = false;
    if (map.dragPan && map.dragPan.enable) map.dragPan.enable();
    const lngLat = map.unproject([fixedX, fixedY]);
    const el = document.createElement('div');
    el.style.width = '45px';
    el.style.height = '45px';
    el.style.cursor = 'pointer';
    const img = document.createElement('div');
    img.style.width = '100%';
    img.style.height = '100%';
    img.style.backgroundImage = `url(${iconImages[selectedIconKey]})`;
    img.style.backgroundSize = 'contain';
    img.style.backgroundRepeat = 'no-repeat';
    img.style.transformOrigin = 'center bottom';
    img.classList.add('custom-marker-icon');
    img.dataset.baseTransform = `rotate(${previewRotation}deg)`;
    img.style.transform = `${img.dataset.baseTransform} scale(1)`;
    el.appendChild(img);
    const marker = new maptilersdk.Marker({ element: el, anchor: 'bottom' })
      .setLngLat(lngLat)
      .addTo(map);
    markers.push(marker);
    el.addEventListener('click', e => {
      e.stopPropagation();
      markerToDelete = marker;
      showModal();
    });
    iconButtonsList.forEach(b => b.classList.remove('active'));
    selectedIconKey = null;
    previewRotation = 0;
    previewIcon.style.display = 'none';
    updateMarkerScales();
  });

  function updateMarkerScales() {
    const zoom = map.getZoom();
    const scale = Math.pow(0.95, 10 - zoom);
    document.querySelectorAll('.custom-marker-icon').forEach(icon => {
      const baseTransform = icon.dataset.baseTransform || '';
      icon.style.transform = `${baseTransform} scale(${scale})`;
    });
  }
  map.on('zoom', updateMarkerScales);
  map.on('load', updateMarkerScales);

  function showModal() { modalOverlay.style.display = 'flex'; }
  function hideModal() { modalOverlay.style.display = 'none'; markerToDelete = null; }
  modalConfirmBtn.addEventListener('click', () => {
    if (markerToDelete) {
      markerToDelete.remove();
      markers = markers.filter(m => m !== markerToDelete);
    }
    hideModal();
  });
  modalCancelBtn.addEventListener('click', hideModal);
  modalOverlay.addEventListener('click', e => { if (e.target === modalOverlay) hideModal(); });
  document.addEventListener('keydown', e => { if (e.key === 'Escape') hideModal(); });
  map.getCanvas().addEventListener('contextmenu', e => e.preventDefault());

  // –í–æ–¥—è–Ω—ñ –∑–Ω–∞–∫–∏
  const watermarkCountX = 4;
  const watermarkCountY = 5;
  for (let y = 0; y < watermarkCountY; y++) {
    for (let x = 0; x < watermarkCountX; x++) {
      const wm = document.createElement('div');
      wm.className = 'watermark';
      const topPercent = (y + 0.5) * (100 / watermarkCountY);
      let leftPercent = (x + 0.5) * (100 / watermarkCountX);
      if (y % 2 === 0) {
        leftPercent += (50 / watermarkCountX);
        if (leftPercent > 100) leftPercent -= 100;
      }
      wm.style.top = `${topPercent}%`;
      wm.style.left = `${leftPercent}%`;
      wm.innerHTML = `<div class="line1">–ö–û–†–ê–ë–ï–õ–ò</div><div class="line2">t.me/korabely_media</div>`;
      document.body.appendChild(wm);
    }
  }
</script>

</body>
</html>
